---
import { assets, history, keywords } from "@/db/schema";
import { db } from "@/db/turso";
import { eq } from "drizzle-orm";

const result = await db.select().from(assets).all();
---

<html lang="en">
  <head><title>Asset Library</title></head>

  <body>
    <h1>Asset Library</h1>

    <section>
      {
        result.map(async (val) => {
          const base64 = val.image.toString("base64");
          const dataUri = `data:image/png;base64,${base64}`;

          const commitsRes = await db
            .select()
            .from(history)
            .where(eq(history.assetName, val.name))
            .orderBy(history.timestamp);

          const keywordsRes = await db
            .select()
            .from(keywords)
            .where(eq(keywords.assetName, val.name))
            .orderBy(keywords.keyword);

          return (
            <div class="asset-result">
              <div class="left">
                <p>Asset name: {val.name}</p>
                <p>Keywords: {keywordsRes.map((key) => key.keyword).join(", ")}</p>
                <p>Number of commits: {commitsRes.length}</p>
                <p>Original author: {commitsRes[0]!.author}</p>
                <p>Current version: {commitsRes[commitsRes.length - 1]!.version}</p>
                <img src={dataUri} alt={`Thumbnail of ${val.name}`} width="200px" height="200px" />
              </div>

              <div class="right">
                .usda file contents
                <pre>{val.file}</pre>
              </div>
            </div>
          );
        })
      }
    </section>
  </body>
</html>

<style>
  section {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .asset-result {
    display: flex;
    gap: 30px;
    background-color: rgb(212, 212, 212);

    > .left {
      width: 32%;
      border-right: 2px solid rgb(134, 134, 134);
    }

    > .right {
      width: 68%;
    }
  }
</style>
